<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>METEOR MADNESS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Arial', sans-serif;
      background: #000;
      overflow: hidden;
    }
    canvas { display: block; }
    
    .ui-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(10, 10, 10, 0.9);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #4fc3f7;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      max-width: 350px;
    }

    .ui-overlay h3 {
      color: #4fc3f7;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .ui-overlay p {
      margin: 5px 0;
      color: #aaa;
      font-size: 13px;
    }

    .ui-overlay strong {
      color: #fff;
    }

    .asteroid-section {
      background: rgba(255, 99, 71, 0.1);
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      border: 1px solid #ff6347;
    }

    .restart-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, #ff4500, #ff6347);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
      transition: all 0.3s ease;
    }

    .restart-btn:hover {
      background: linear-gradient(135deg, #ff6347, #ff7f50);
      transform: translateY(-2px);
    }

    .choice-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
      padding: 40px;
      border-radius: 20px;
      border: 3px solid #ff6347;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 0 50px rgba(255, 99, 71, 0.5);
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from { transform: scale(0.5); }
      to { transform: scale(1); }
    }

    .modal-content h2 {
      color: #ff6347;
      font-size: 32px;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255, 99, 71, 0.8);
    }

    .modal-content p {
      color: #ccc;
      font-size: 16px;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
    }

    .modal-btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-again {
      background: linear-gradient(135deg, #ff4500, #ff6347);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
    }

    .btn-again:hover {
      background: linear-gradient(135deg, #ff6347, #ff7f50);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 69, 0, 0.6);
    }

    .btn-crater {
      background: linear-gradient(135deg, #4fc3f7, #29b6f6);
      color: white;
      box-shadow: 0 4px 15px rgba(79, 195, 247, 0.4);
    }

    .btn-crater:hover {
      background: linear-gradient(135deg, #29b6f6, #03a9f4);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 195, 247, 0.6);
    }

    .impact-stats {
      background: rgba(255, 99, 71, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid #ff6347;
    }

    .impact-stats p {
      color: #fff;
      margin: 8px 0;
      font-size: 15px;
      text-align: left;
    }

    .stat-highlight {
      color: #ff6347;
      font-weight: bold;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="ui-overlay">
    <h3>Target Location</h3>
    <p><strong>Location:</strong> <span id="target-name">Loading...</span></p>
    <p><strong>Coordinates:</strong> <span id="target-coords">Loading...</span></p>
    
    <div class="asteroid-section">
      <p style="color: #ff6347; font-weight: bold; margin-bottom: 8px;">NASA Asteroid Data</p>
      <p><strong>Name:</strong> <span id="meteor-name">-</span></p>
      <p><strong>Diameter:</strong> <span id="meteor-diameter">-</span></p>
      <p><strong>Velocity:</strong> <span id="meteor-speed">-</span></p>
      <p><strong>Energy:</strong> <span id="meteor-energy">-</span></p>
    </div>
    
    <p style="margin-top: 10px;"><strong>Status:</strong> <span id="status">Preparing...</span></p>
  </div>

  <button class="restart-btn" onclick="restartSimulation()">ðŸ”„ Restart Simulation</button>

  <div class="choice-modal" id="choiceModal">
    <div class="modal-content">
      <h2>IMPACT DETECTED!</h2>
      <div class="impact-stats">
        <p><strong>Asteroid:</strong> <span id="modal-asteroid"></span></p>
        <p><strong>Target Hit:</strong> <span id="modal-location"></span></p>
        <p><strong>Impact Velocity:</strong> <span class="stat-highlight" id="impact-velocity"></span></p>
        <p><strong>Kinetic Energy:</strong> <span class="stat-highlight" id="impact-energy"></span></p>
        <p><strong>TNT Equivalent:</strong> <span class="stat-highlight" id="impact-megatons"></span></p>
        <p><strong>Crater Diameter:</strong> <span class="stat-highlight" id="crater-diameter"></span></p>
        <p><strong>Damage Radius:</strong> <span class="stat-highlight" id="damage-radius"></span></p>
      </div>
      <p>The asteroid has successfully struck the target location. What would you like to do next?</p>
      <div class="modal-buttons">
        <button class="modal-btn btn-again" onclick="launchAgain()">Launch Again</button>
        <button class="modal-btn btn-crater" onclick="viewCrater()">View Crater</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    const targetLat = parseFloat(sessionStorage.getItem('targetLat')) || 0;
    const targetLng = parseFloat(sessionStorage.getItem('targetLng')) || 0;
    const targetName = sessionStorage.getItem('targetName') || 'Unknown Location';
    const meteorName = sessionStorage.getItem('meteorName') || 'Unknown Asteroid';
    const meteorSpeed = parseFloat(sessionStorage.getItem('meteorSpeed')) || 20;
    const meteorMass = parseFloat(sessionStorage.getItem('meteorMass')) || 1000000;
    const meteorDiameter = parseFloat(sessionStorage.getItem('meteorDiameter')) || 100;
    const meteorEnergy = parseFloat(sessionStorage.getItem('meteorEnergy')) || 1;

    document.getElementById('target-name').textContent = targetName;
    document.getElementById('target-coords').textContent = `${targetLat.toFixed(4)}Â°, ${targetLng.toFixed(4)}Â°`;
    document.getElementById('meteor-name').textContent = meteorName;
    document.getElementById('meteor-diameter').textContent = `${meteorDiameter.toFixed(1)} m`;
    document.getElementById('meteor-speed').textContent = `${meteorSpeed.toFixed(2)} km/s`;
    document.getElementById('meteor-energy').textContent = `${meteorEnergy.toFixed(2)} MT`;

    function calculateImpactPhysics() {
      const speedMs = meteorSpeed * 1000;
      const kineticEnergy = 0.5 * meteorMass * speedMs * speedMs;
      const megatonsTNT = kineticEnergy / 4.184e15;
      
      const impactorDiameter = meteorDiameter;
      const impactorDensity = 2600;
      const targetDensity = 2500;
      const gravity = 9.81;
      const impactAngle = 45;
      
      const craterDiameterMeters = 1.161 * 
        Math.pow(impactorDiameter, 0.78) * 
        Math.pow(speedMs, 0.44) * 
        Math.pow(impactorDensity, 0.33) * 
        Math.pow(targetDensity, -0.22) * 
        Math.pow(gravity, -0.22) *
        Math.pow(Math.sin(impactAngle * Math.PI / 180), 0.33);
      
      const craterDiameter = craterDiameterMeters / 1000;
      
      const severeRadius = craterDiameter * 5;
      const damageRadius = craterDiameter * 10;
      
      const energyBasedRadius = 4.6 * Math.pow(megatonsTNT, 0.33);
      
      const finalDamageRadius = (damageRadius * 0.6 + energyBasedRadius * 0.4);
      
      return {
        kineticEnergy: kineticEnergy,
        megatonsTNT: megatonsTNT,
        craterDiameter: craterDiameter,
        damageRadius: finalDamageRadius,
        severeRadius: severeRadius,
        impactorDiameter: impactorDiameter
      };
    }

    const impactData = calculateImpactPhysics();

    console.log('=== NASA Asteroid Impact Physics ===');
    console.log('Asteroid:', meteorName);
    console.log('Diameter:', meteorDiameter, 'm');
    console.log('Mass:', meteorMass, 'kg');
    console.log('Velocity:', meteorSpeed, 'km/s');
    console.log('Energy (Joules):', impactData.kineticEnergy.toExponential(3));
    console.log('Energy (MT):', impactData.megatonsTNT.toFixed(4));
    console.log('Crater Diameter:', impactData.craterDiameter.toFixed(2), 'km');
    console.log('Damage Radius:', impactData.damageRadius.toFixed(2), 'km');
    console.log('====================================');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
    camera.position.set(0, 100, 300);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    const earthRadius = 50;
    controls.minDistance = earthRadius * 1.2;
    controls.maxDistance = 800;

    const starsGeometry = new THREE.SphereGeometry(2000, 64, 64);
    const starsMaterial = new THREE.MeshBasicMaterial({
      map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/starfield.jpg"),
      side: THREE.BackSide
    });
    const stars = new THREE.Mesh(starsGeometry, starsMaterial);
    scene.add(stars);

    const sunLight = new THREE.PointLight(0xffffff, 3, 0);
    sunLight.position.set(0, 0, 0);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 2.5));

    const earthOrbit = new THREE.Object3D();
    scene.add(earthOrbit);

    let initialEarthRotationY = 0;

    function createEarth() {
      const earthGeometry = new THREE.SphereGeometry(earthRadius, 128, 128);
      const earthMaterial = new THREE.MeshPhongMaterial({
        map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"),
        specularMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_specular_2048.jpg"),
        bumpMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_bump_2048.jpg"),
        bumpScale: 0.1,
        side: THREE.FrontSide
      });
      const earth = new THREE.Mesh(earthGeometry, earthMaterial);
      earth.position.set(150, 0, 0);
      earth.rotation.z = THREE.MathUtils.degToRad(23.5);
      initialEarthRotationY = earth.rotation.y;
      earthOrbit.add(earth);
      
      addCountryBorders(earth);
      return earth;
    }

    function addCountryBorders(earth) {
      fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
        .then(res => res.json())
        .then(worldData => {
          const countries = topojson.feature(worldData, worldData.objects.countries);
          const material = new THREE.LineBasicMaterial({ color: 0x00ff88, linewidth: 1 });

          countries.features.forEach(feature => {
            const coords = feature.geometry.coordinates;
            if (feature.geometry.type === "Polygon") {
              drawPolygon(coords, earth, material);
            } else if (feature.geometry.type === "MultiPolygon") {
              coords.forEach(polygon => drawPolygon(polygon, earth, material));
            }
          });
        })
        .catch(err => console.error('Failed to load borders:', err));
    }

    function drawPolygon(polygon, earth, material) {
      polygon.forEach(ring => {
        const points = [];
        ring.forEach(([lon, lat]) => {
          points.push(latLngToVector3(lat, lon, earthRadius + 0.05));
        });
        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const line = new THREE.Line(geometry, material);
        earth.add(line);
      });
    }

    function latLngToVector3(lat, lng, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lng + 180) * (Math.PI / 180);
      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = (radius * Math.sin(phi) * Math.sin(theta));
      const y = (radius * Math.cos(phi));
      return new THREE.Vector3(x, y, z);
    }

    const start = new THREE.Vector3(500, 80, 0);
    let end = new THREE.Vector3(150, 0, 0);

    const orbitGeo = new THREE.BufferGeometry();
    const orbitMat = new THREE.LineDashedMaterial({ 
      color: 0xff6347, 
      dashSize: 4, 
      gapSize: 3,
      linewidth: 2
    });
    const orbit = new THREE.Line(orbitGeo, orbitMat);
    scene.add(orbit);

    let meteor = null;
    let earth = createEarth();

    const animationSpeed = 0.005 + (meteorSpeed / 50) * 0.01;
    
    let meteorSize = meteorDiameter / 25;
    meteorSize = Math.max(1.5, Math.min(15, meteorSize));

    let angle = 0;

    let targetMarker = null;
    function createTargetMarker() {
      const markerGeometry = new THREE.SphereGeometry(1, 16, 16);
      const markerMaterial = new THREE.MeshBasicMaterial({ 
        color: 0xff0000,
        transparent: true,
        opacity: 0.9
      });
      targetMarker = new THREE.Mesh(markerGeometry, markerMaterial);
      
      const glowGeometry = new THREE.SphereGeometry(1.5, 16, 16);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0xff4444,
        transparent: true,
        opacity: 0.4
      });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      targetMarker.add(glow);
      
      const targetPos = latLngToVector3(targetLat, targetLng, earthRadius + 0.2);
      targetMarker.position.copy(targetPos);
      
      earth.add(targetMarker);
    }
    
    createTargetMarker();

    function createMeteor(size) {
      const geometry = new THREE.SphereGeometry(size, 32, 32);
      geometry.computeVertexNormals();
      
      const textureLoader = new THREE.TextureLoader();
      const material = new THREE.MeshStandardMaterial({
        map: textureLoader.load("rock.png", undefined, undefined, () => {
          console.warn("Failed to load rock.png - using fallback color");
        }),
        roughnessMap: textureLoader.load("rockroughness.png", undefined, undefined, () => {
          console.warn("Failed to load rockroughness.png");
        }),
        normalMap: textureLoader.load("rocknormal.png", undefined, undefined, () => {
          console.warn("Failed to load rocknormal.png");
        }),
        bumpMap: textureLoader.load("rockbumpmap.png", undefined, undefined, () => {
          console.warn("Failed to load rockbumpmap.png");
        }),
        displacementMap: textureLoader.load("rockdisplacementmap.png", undefined, undefined, () => {
          console.warn("Failed to load rockdisplacementmap.png");
        }),
        displacementScale: 0.4,
        aoMap: textureLoader.load("rockao.png", undefined, undefined, () => {
          console.warn("Failed to load rockao.png");
        }),
        color: 0x8b7355,
        roughness: 0.95,
        metalness: 0.05
      });
      
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.copy(start);
      scene.add(mesh);
      
      return mesh;
    }

    function createExplosion(position) {
      const explosionGroup = new THREE.Group();
      explosionGroup.position.copy(position);
      scene.add(explosionGroup);

      const explosionScale = Math.min(1.5, 0.4 + impactData.megatonsTNT / 400);

      for (let i = 0; i < 3; i++) {
        const shockGeo = new THREE.SphereGeometry((1.5 + i * 0.4) * explosionScale, 32, 32);
        const shockMat = new THREE.MeshBasicMaterial({
          color: i === 0 ? 0xffff00 : (i === 1 ? 0xffaa00 : 0xff6600),
          transparent: true,
          opacity: 0.9 - i * 0.2,
          side: THREE.DoubleSide
        });
        const shockwave = new THREE.Mesh(shockGeo, shockMat);
        explosionGroup.add(shockwave);
      }

      const particleCount = Math.min(100, 50 + Math.floor(impactData.megatonsTNT * 1.5));
      for (let i = 0; i < particleCount; i++) {
        const size = 0.2 + Math.random() * 0.4;
        const geo = new THREE.SphereGeometry(size, 6, 6);
        const mat = new THREE.MeshBasicMaterial({
          color: i % 2 === 0 ? 0xff4500 : 0xffa500,
          transparent: true,
          opacity: 1
        });
        const p = new THREE.Mesh(geo, mat);

        const dir = new THREE.Vector3(
          (Math.random() - 0.5) * 2,
          (Math.random() - 0.5) * 2,
          (Math.random() - 0.5) * 2
        ).normalize().multiplyScalar(0.8 + Math.random() * 2);

        p.userData.velocity = dir;
        p.userData.life = 1.0;
        explosionGroup.add(p);
      }

      for (let i = 0; i < 35; i++) {
        const geo = new THREE.BoxGeometry(0.15, 0.15, 0.3);
        const mat = new THREE.MeshBasicMaterial({ color: 0x333333 });
        const debris = new THREE.Mesh(geo, mat);
        
        const dir = new THREE.Vector3(
          (Math.random() - 0.5) * 2,
          Math.random(),
          (Math.random() - 0.5) * 2
        ).normalize().multiplyScalar(0.4 + Math.random() * 1.3);
        
        debris.userData.velocity = dir;
        debris.userData.rotationSpeed = new THREE.Vector3(
          Math.random() * 0.2,
          Math.random() * 0.2,
          Math.random() * 0.2
        );
        explosionGroup.add(debris);
      }

      let frame = 0;
      const maxFrames = 90;
      const explosionInterval = setInterval(() => {
        frame++;
        
        explosionGroup.children.forEach((child, index) => {
          if (index < 3) {
            const scale = 1 + frame * 0.6 * explosionScale;
            child.scale.set(scale, scale, scale);
            child.material.opacity = Math.max(0, 0.9 - frame * 0.012);
          } else {
            if (child.userData.velocity) {
              child.position.add(child.userData.velocity);
              child.userData.velocity.multiplyScalar(0.97);
              
              if (child.userData.life !== undefined) {
                child.userData.life -= 0.018;
                child.material.opacity = Math.max(0, child.userData.life);
              }
              
              if (child.userData.rotationSpeed) {
                child.rotation.x += child.userData.rotationSpeed.x;
                child.rotation.y += child.userData.rotationSpeed.y;
                child.rotation.z += child.userData.rotationSpeed.z;
              }
            }
          }
        });

        if (frame >= maxFrames) {
          clearInterval(explosionInterval);
          scene.remove(explosionGroup);
          showChoiceModal();
        }
      }, 30);
    }

    function showChoiceModal() {
      const modal = document.getElementById('choiceModal');
      document.getElementById('modal-asteroid').textContent = meteorName;
      document.getElementById('modal-location').textContent = targetName;
      document.getElementById('impact-velocity').textContent = `${meteorSpeed.toFixed(2)} km/s`;
      document.getElementById('impact-energy').textContent = 
        `${impactData.kineticEnergy.toExponential(2)} Joules`;
      document.getElementById('impact-megatons').textContent = 
        `${impactData.megatonsTNT.toFixed(4)} Megatons TNT`;
      document.getElementById('crater-diameter').textContent = 
        `${impactData.craterDiameter.toFixed(2)} km`;
      document.getElementById('damage-radius').textContent = 
        `${impactData.damageRadius.toFixed(2)} km`;
      modal.style.display = 'flex';
    }

    window.launchAgain = function() {
      document.getElementById('choiceModal').style.display = 'none';
      
      angle = 0;
      document.getElementById('status').textContent = 'Preparing...';
      
      earth.rotation.y = initialEarthRotationY;
      
      if (!targetMarker) {
        createTargetMarker();
      }
      
      if (!meteor) {
        meteor = createMeteor(meteorSize);
      }
    };

    window.viewCrater = function() {
      sessionStorage.setItem('impactEnergy', impactData.kineticEnergy);
      sessionStorage.setItem('impactMegatons', impactData.megatonsTNT);
      sessionStorage.setItem('craterDiameter', impactData.craterDiameter);
      sessionStorage.setItem('damageRadius', impactData.damageRadius);
      
      document.getElementById('choiceModal').style.display = 'none';
      window.location.href = 'freecrater.html';
    };

    window.restartSimulation = function() {
      window.location.href = 'simulation.html';
    };

    meteor = createMeteor(meteorSize);

    function animate() {
      requestAnimationFrame(animate);
      
      earth.rotation.y += 0.001;
      controls.target.copy(earth.getWorldPosition(new THREE.Vector3()));
      controls.update();
      
      if (targetMarker && targetMarker.children[0]) {
        const pulse = Math.sin(Date.now() * 0.003) * 0.15 + 0.4;
        targetMarker.children[0].material.opacity = pulse;
      }
      
      if (meteor) {
        const currentTarget = targetMarker.getWorldPosition(new THREE.Vector3());
        
        meteor.rotation.x += 0.03;
        meteor.rotation.y += 0.02;

        angle += animationSpeed;

        if (angle >= 1) {
          document.getElementById('status').textContent = 'IMPACT!';
          
          const impactPos = currentTarget.clone();
          createExplosion(impactPos);
          
          if (targetMarker) {
            earth.remove(targetMarker);
            targetMarker = null;
          }
          
          scene.remove(meteor);
          meteor = null;
        } else {
          const pos = new THREE.Vector3().lerpVectors(start, currentTarget, angle);
          meteor.position.copy(pos);
          
          const progress = (angle * 100).toFixed(0);
          document.getElementById('status').textContent = `In Flight: ${progress}%`;
        }
        
        const points = [start, currentTarget];
        orbitGeo.setFromPoints(points);
        orbit.computeLineDistances();
      }
      
      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>