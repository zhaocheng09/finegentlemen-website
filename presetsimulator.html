<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>METEOR MADNESS</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Arial', sans-serif;
      background: #0a0a0a;
      color: #fff;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .left-panel {
      flex: 1;
      position: relative;
      background: #000;
    }

    #earth-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .launch-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, #ff4500, #ff6347);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      z-index: 10;
    }

    .launch-btn:hover:not(.disabled) {
      background: linear-gradient(135deg, #ff6347, #ff7f50);
      box-shadow: 0 6px 20px rgba(255, 69, 0, 0.6);
      transform: translateY(-2px);
    }

    .launch-btn.disabled {
      background: linear-gradient(135deg, #666, #888);
      cursor: not-allowed;
      box-shadow: none;
    }

    .right-panel {
      width: 480px;
      display: flex;
      flex-direction: column;
      background: #1a1a1a;
      border-left: 2px solid #333;
      overflow: hidden;
    }

    .right-panel-scroll {
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .right-panel-scroll::-webkit-scrollbar {
      width: 12px;
    }

    .right-panel-scroll::-webkit-scrollbar-track {
      background: #0d0d0d;
    }

    .right-panel-scroll::-webkit-scrollbar-thumb {
      background: #4fc3f7;
      border-radius: 6px;
      border: 2px solid #0d0d0d;
    }

    .right-panel-scroll::-webkit-scrollbar-thumb:hover {
      background: #5fd4ff;
    }

    .map-header {
      background: #0d0d0d;
      padding: 15px 20px;
      border-bottom: 2px solid #333;
      flex-shrink: 0;
    }

    .map-header h2 {
      font-size: 20px;
      color: #4fc3f7;
      margin-bottom: 5px;
    }

    .map-header p {
      font-size: 12px;
      color: #888;
    }

    .preset-section {
      padding: 15px 20px;
      background: #151515;
      border-bottom: 1px solid #333;
    }

    .preset-section h3 {
      font-size: 14px;
      color: #ff6347;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 280px;
      overflow-y: auto;
      padding: 5px;
    }

    .preset-grid::-webkit-scrollbar {
      width: 6px;
    }

    .preset-grid::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    .preset-grid::-webkit-scrollbar-thumb {
      background: #4fc3f7;
      border-radius: 3px;
    }

    .preset-card {
      background: rgba(42, 47, 64, 0.5);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid rgba(79, 195, 247, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preset-card:hover {
      background: rgba(79, 195, 247, 0.2);
      border-color: #4fc3f7;
      transform: translateY(-2px);
    }

    .preset-card.selected {
      background: rgba(79, 195, 247, 0.3);
      border-color: #4fc3f7;
      border-width: 2px;
    }

    .preset-name {
      font-size: 11px;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preset-detail {
      font-size: 9px;
      color: #aaa;
      margin: 2px 0;
    }

    .preset-energy {
      font-size: 10px;
      color: #ff6347;
      font-weight: bold;
      margin-top: 4px;
    }

    .loading-message {
      text-align: center;
      padding: 20px;
      color: #4fc3f7;
      font-size: 12px;
      grid-column: 1 / -1;
    }

    .cache-info {
      font-size: 10px;
      color: #888;
      text-align: center;
      margin-top: 8px;
      padding: 5px;
      background: rgba(79, 195, 247, 0.1);
      border-radius: 4px;
    }

    .selected-meteor-info {
      background: rgba(255, 99, 71, 0.2);
      padding: 12px 20px;
      border-bottom: 1px solid #ff6347;
    }

    .selected-meteor-info h4 {
      color: #ff6347;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .selected-meteor-info p {
      font-size: 10px;
      color: #ccc;
      margin: 3px 0;
      line-height: 1.4;
    }

    .map-controls {
      padding: 15px 20px;
      background: #151515;
      border-bottom: 1px solid #333;
    }

    .control-group {
      background: rgba(42, 47, 64, 0.5);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid rgba(79, 195, 247, 0.3);
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group h3 {
      font-size: 12px;
      color: #4fc3f7;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .input-row:last-child {
      margin-bottom: 0;
    }

    .input-row label {
      font-size: 11px;
      color: #aaa;
      min-width: 70px;
    }

    .input-row input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #2a2f40;
      color: white;
      font-size: 12px;
    }

    .btn {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: linear-gradient(90deg, #2e4da7, #5f5fe0);
      color: white;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s ease;
      margin-top: 5px;
    }

    .btn:hover {
      background: linear-gradient(90deg, #4169e1, #7b7bff);
      box-shadow: 0 0 10px rgba(65,105,225,0.5);
    }

    .map-wrapper {
      padding: 15px 20px;
      background: #151515;
    }

    .map-container {
      width: 100%;
      height: 400px;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid #333;
    }

    #map {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .marker {
      background-color: #ff4444;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .location-status {
      background: rgba(79, 195, 247, 0.2);
      padding: 12px 20px;
      text-align: center;
      font-size: 11px;
      color: #4fc3f7;
      border-top: 1px solid rgba(79, 195, 247, 0.4);
      margin: 15px 20px 20px;
      border-radius: 6px;
    }

    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      .left-panel {
        height: 50vh;
      }
      .right-panel {
        width: 100%;
        height: 50vh;
      }
    }
     .restart-btn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .restart-btn:hover {
      background: linear-gradient(135deg, #764ba2, #8b5fc7);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <canvas id="earth-canvas"></canvas>
      <button class="launch-btn disabled" id="launch-btn" onclick="launchSimulation()">‚òÑÔ∏è Launch</button>
      <button class="restart-btn" onclick="window.location.href='simulation.html'">üîÑ Restart Simulation</button>
    </div>

    <div class="right-panel">
      <div class="right-panel-scroll">
        <div class="map-header">
          <h2>NASA Meteor Impact Simulator</h2>
          <p>Select a real asteroid and target location</p>
        </div>

        <div class="preset-section">
          <h3>üì° Select NASA Asteroid</h3>
          <div class="preset-grid" id="preset-grid">
            <div class="loading-message">Loading NASA asteroid data...</div>
          </div>
          <div class="cache-info" id="cache-info"></div>
        </div>

        <div class="selected-meteor-info" id="meteor-info" style="display: none;">
          <h4>Selected Asteroid</h4>
          <p id="meteor-details"></p>
        </div>

        <div class="map-controls">
          <div class="control-group">
            <h3>üåç Search Location</h3>
            <div class="input-row">
              <input type="text" id="location-search" placeholder="Enter city, country, or landmark..." style="min-width: 100%;" />
            </div>
            <button class="btn" onclick="searchLocation()">Search Location</button>
          </div>

          <div class="control-group">
            <h3>üìç Manual Coordinates</h3>
            <div class="input-row">
              <label>Latitude:</label>
              <input type="number" id="lat" step="any" placeholder="e.g. 39.907" />
            </div>
            <div class="input-row">
              <label>Longitude:</label>
              <input type="number" id="lng" step="any" placeholder="e.g. 116.391" />
            </div>
            <button class="btn" onclick="goToCoordinates()">Go to Coordinates</button>
          </div>
        </div>

        <div class="map-wrapper">
          <div class="map-container">
            <div id="map"></div>
          </div>
        </div>

        <div class="location-status" id="location-status">
          Select an asteroid and target location to begin
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <script>
    // Cache management
    const CACHE_KEY = 'nasa_neo_data';
    const CACHE_TIMESTAMP_KEY = 'nasa_neo_data_timestamp';
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

    // NASA Asteroid Data
    let nasaData = [];
    let isDataLoaded = false;

    // Sample NASA data as fallback
    const SAMPLE_NASA_DATA = [
      { name: "Apophis (2004 MN4)", diameter_m: 370, velocity_km_s: 12.6, energy_megatons: 1151, miss_distance_km: 31000, id: "2004MN4" },
      { name: "Bennu (1999 RQ36)", diameter_m: 490, velocity_km_s: 28.6, energy_megatons: 2790, miss_distance_km: 480000, id: "1999RQ36" },
      { name: "1950 DA", diameter_m: 1100, velocity_km_s: 15.2, energy_megatons: 15840, miss_distance_km: 6000000, id: "1950DA" },
      { name: "2023 DW", diameter_m: 50, velocity_km_s: 21.3, energy_megatons: 28, miss_distance_km: 7500000, id: "2023DW" },
      { name: "2022 AP7", diameter_m: 1500, velocity_km_s: 18.7, energy_megatons: 38900, miss_distance_km: 4500000, id: "2022AP7" },
      { name: "Eros (433)", diameter_m: 16840, velocity_km_s: 5.8, energy_megatons: 425000, miss_distance_km: 21000000, id: "433" },
      { name: "Toutatis (4179)", diameter_m: 2500, velocity_km_s: 11.3, energy_megatons: 28100, miss_distance_km: 1500000, id: "4179" },
      { name: "Florence (3122)", diameter_m: 4500, velocity_km_s: 13.5, energy_megatons: 194000, miss_distance_km: 7000000, id: "3122" },
      { name: "2008 AG33", diameter_m: 350, velocity_km_s: 23.2, energy_megatons: 1180, miss_distance_km: 3200000, id: "2008AG33" },
      { name: "2021 PH27", diameter_m: 1000, velocity_km_s: 19.4, energy_megatons: 13900, miss_distance_km: 2800000, id: "2021PH27" },
      { name: "Didymos (65803)", diameter_m: 780, velocity_km_s: 5.4, energy_megatons: 1680, miss_distance_km: 6000000, id: "65803" },
      { name: "2019 OK", diameter_m: 100, velocity_km_s: 24.5, energy_megatons: 430, miss_distance_km: 73000, id: "2019OK" },
      { name: "Ryugu (162173)", diameter_m: 900, velocity_km_s: 7.9, energy_megatons: 4150, miss_distance_km: 9500000, id: "162173" },
      { name: "Phaethon (3200)", diameter_m: 5100, velocity_km_s: 31.9, energy_megatons: 389000, miss_distance_km: 10000000, id: "3200" },
      { name: "2020 XL5", diameter_m: 1200, velocity_km_s: 16.2, energy_megatons: 18800, miss_distance_km: 4200000, id: "2020XL5" },
      { name: "Icarus (1566)", diameter_m: 1400, velocity_km_s: 22.8, energy_megatons: 42900, miss_distance_km: 6300000, id: "1566" },
      { name: "2001 CB21", diameter_m: 700, velocity_km_s: 14.3, energy_megatons: 5290, miss_distance_km: 5000000, id: "2001CB21" },
      { name: "2023 NT1", diameter_m: 60, velocity_km_s: 25.6, energy_megatons: 58, miss_distance_km: 2800000, id: "2023NT1" },
      { name: "Itokawa (25143)", diameter_m: 330, velocity_km_s: 8.2, energy_megatons: 650, miss_distance_km: 7500000, id: "25143" },
      { name: "2018 VP1", diameter_m: 2, velocity_km_s: 11.8, energy_megatons: 0.002, miss_distance_km: 420, id: "2018VP1" }
    ];

    function getCachedData() {
      try {
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        
        if (cachedData && cachedTimestamp) {
          const age = Date.now() - parseInt(cachedTimestamp);
          if (age < CACHE_DURATION) {
            console.log(`Using cached data (age: ${(age / 1000 / 60).toFixed(1)} minutes)`);
            return JSON.parse(cachedData);
          } else {
            console.log('Cache expired, fetching fresh data');
          }
        }
      } catch (e) {
        console.error('Error reading cache:', e);
      }
      return null;
    }

    function setCachedData(data) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
        console.log('Data cached successfully');
      } catch (e) {
        console.error('Error setting cache:', e);
      }
    }

    function updateCacheInfo(fromCache = false) {
      const cacheInfo = document.getElementById('cache-info');
      if (fromCache) {
        const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        const cacheDate = new Date(parseInt(timestamp));
        cacheInfo.innerHTML = `üì¶ Loaded from cache (${cacheDate.toLocaleString()})`;
      } else {
        cacheInfo.innerHTML = `üîÑ Fresh data loaded`;
      }
    }

    async function loadNEOData() {
      const presetGrid = document.getElementById('preset-grid');
      
      // Try cache first (fastest)
      const cachedData = getCachedData();
      if (cachedData && cachedData.length > 0) {
        nasaData = cachedData;
        isDataLoaded = true;
        populatePresetGrid();
        updateCacheInfo(true);
        console.log('‚úÖ Loaded from localStorage cache');
        return;
      }

      // Try loading from static JSON file (faster than API)
      try {
        console.log('üì• Loading from nasa_neo_data.json...');
        presetGrid.innerHTML = '<div class="loading-message">üì¶ Loading asteroid data...</div>';
        
        const jsonResponse = await fetch('nasa_neo_data.json');
        if (jsonResponse.ok) {
          const jsonData = await jsonResponse.json();
          
          if (jsonData.asteroids && Array.isArray(jsonData.asteroids)) {
            nasaData = jsonData.asteroids;
            console.log(`‚úÖ Loaded ${nasaData.length} asteroids from JSON file`);
            console.log('Last updated:', jsonData.metadata.last_updated);
            
            // Cache for next time
            setCachedData(nasaData);
            updateCacheInfo(false);
            
            isDataLoaded = true;
            populatePresetGrid();
            return;
          }
        }
      } catch (jsonErr) {
        console.log('JSON file not found, trying API...', jsonErr.message);
      }

      // Try API as fallback
      try {
        console.log('üåê Fetching from API...');
        presetGrid.innerHTML = '<div class="loading-message">üåê Fetching from NASA API...</div>';
        
        const apiResponse = await fetch("https://meteor-madness-fine-gentlemen.onrender.com/neos/analyze", {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (!apiResponse.ok) {
          throw new Error(`HTTP ${apiResponse.status}: ${apiResponse.statusText}`);
        }

        const rawData = await apiResponse.json();
        console.log('Raw API data:', rawData);

        // Handle different response formats
        let dataArray = [];
        
        if (Array.isArray(rawData)) {
          dataArray = rawData;
        } else if (rawData && typeof rawData === 'object') {
          if (Array.isArray(rawData.asteroids)) dataArray = rawData.asteroids;
          else if (Array.isArray(rawData.data)) dataArray = rawData.data;
          else if (Array.isArray(rawData.neos)) dataArray = rawData.neos;
          else if (Array.isArray(rawData.results)) dataArray = rawData.results;
          else dataArray = Object.values(rawData);
        }

        if (dataArray.length === 0) throw new Error('No data in API response');

        nasaData = dataArray.map(item => ({
          diameter_m: item.diameter_m || item.diameter || 0,
          energy_megatons: item.energy_megatons || item.energy || 0,
          id: item.id?.toString() || item.neo_id?.toString() || "",
          miss_distance_km: item.miss_distance_km || item.miss_distance || 0,
          name: item.name || "Unknown Asteroid",
          velocity_km_s: item.velocity_km_s || item.velocity || 0
        }));

        console.log(`‚úÖ Loaded ${nasaData.length} asteroids from API`);
        setCachedData(nasaData);
        updateCacheInfo(false);
        isDataLoaded = true;
        populatePresetGrid();

      } catch (apiErr) {
        console.error("‚ùå All data sources failed:", apiErr);
        
        // Use hardcoded sample data as last resort
        nasaData = SAMPLE_NASA_DATA;
        isDataLoaded = true;
        populatePresetGrid();
        
        presetGrid.insertAdjacentHTML('afterbegin', `
          <div class="loading-message" style="color: #ffaa00; grid-column: 1 / -1;">
            ‚ö†Ô∏è Using fallback data (API & JSON unavailable)
          </div>
        `);
      }
    }

    // Populate preset grid with asteroid cards
    function populatePresetGrid() {
      const presetGrid = document.getElementById('preset-grid');
      presetGrid.innerHTML = '';

      if (nasaData.length === 0) {
        presetGrid.innerHTML = '<div class="loading-message">No asteroid data available</div>';
        return;
      }

      nasaData.forEach(meteor => {
        const card = document.createElement('div');
        card.className = 'preset-card';
        card.innerHTML = `
          <div class="preset-name" title="${meteor.name}">${meteor.name}</div>
          <div class="preset-detail">Diameter: ${meteor.diameter_m.toFixed(1)}m</div>
          <div class="preset-detail">Speed: ${meteor.velocity_km_s.toFixed(1)} km/s</div>
          <div class="preset-energy">${meteor.energy_megatons.toFixed(2)} MT</div>
        `;
        card.onclick = () => selectMeteor(meteor, card);
        presetGrid.appendChild(card);
      });

      console.log(`Populated ${nasaData.length} asteroid cards`);
    }

    // State
    let selectedMeteor = null;
    let selectedLat = null;
    let selectedLng = null;
    let selectedLocationName = "";

    // 3D Earth Setup
    const canvas = document.getElementById('earth-canvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 5000);
    camera.position.set(0, 50, 250);
    
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    const earthRadius = 100;
    controls.minDistance = earthRadius * 1.5;
    controls.maxDistance = 400;

    const stars = new THREE.Mesh(
      new THREE.SphereGeometry(3000, 64, 64),
      new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/starfield.jpg"),
        side: THREE.BackSide
      })
    );
    scene.add(stars);

    const sunLight = new THREE.DirectionalLight(0xffffff, 1);
    sunLight.position.set(5, 3, 5);
    scene.add(sunLight);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));

    const earthGeometry = new THREE.SphereGeometry(earthRadius, 128, 128);
    const earthMaterial = new THREE.MeshPhongMaterial({
      map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"),
      specularMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_specular_2048.jpg"),
      bumpMap: new THREE.TextureLoader().load("https://threejs.org/examples/textures/planets/earth_bump_2048.jpg"),
      bumpScale: 0.3,
      side: THREE.FrontSide
    });
    const earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);

    let markerMesh = null;
    function createEarthMarker(lat, lng) {
      if (markerMesh) {
        earth.remove(markerMesh);
      }

      const markerGeometry = new THREE.SphereGeometry(3, 16, 16);
      const markerMaterial = new THREE.MeshBasicMaterial({ 
        color: 0xff4444,
        transparent: true,
        opacity: 0.9
      });
      markerMesh = new THREE.Mesh(markerGeometry, markerMaterial);

      const position = latLngToVector3(lat, lng, earthRadius + 1);
      markerMesh.position.copy(position);

      const glowGeometry = new THREE.SphereGeometry(4, 16, 16);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0xff8888,
        transparent: true,
        opacity: 0.3
      });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      markerMesh.add(glow);

      earth.add(markerMesh);
    }

    function latLngToVector3(lat, lng, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lng + 180) * (Math.PI / 180);
      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = (radius * Math.sin(phi) * Math.sin(theta));
      const y = (radius * Math.cos(phi));
      return new THREE.Vector3(x, y, z);
    }

    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
      .then(res => res.json())
      .then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries);
        const material = new THREE.LineBasicMaterial({ color: 0x00ff88, linewidth: 1 });

        countries.features.forEach(feature => {
          const coords = feature.geometry.coordinates;
          if (feature.geometry.type === "Polygon") {
            drawPolygon(coords);
          } else if (feature.geometry.type === "MultiPolygon") {
            coords.forEach(polygon => drawPolygon(polygon));
          }
        });

        function drawPolygon(polygon) {
          polygon.forEach(ring => {
            const points = [];
            ring.forEach(([lon, lat]) => {
              points.push(latLngToVector3(lat, lon, earthRadius + 0.1));
            });
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);
            earth.add(line);
          });
        }
      });

    function animate() {
      requestAnimationFrame(animate);
      earth.rotation.y += 0.001;
      
      if (markerMesh && markerMesh.children[0]) {
        const pulse = Math.sin(Date.now() * 0.003) * 0.1 + 0.3;
        markerMesh.children[0].material.opacity = pulse;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    });

    function selectMeteor(meteor, cardElement) {
      selectedMeteor = meteor;
      
      document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
      cardElement.classList.add('selected');
      
      document.getElementById('meteor-info').style.display = 'block';
      document.getElementById('meteor-details').innerHTML = `
        <strong>Name:</strong> ${meteor.name}<br>
        <strong>Diameter:</strong> ${meteor.diameter_m.toFixed(1)} meters<br>
        <strong>Velocity:</strong> ${meteor.velocity_km_s.toFixed(2)} km/s<br>
        <strong>Energy:</strong> ${meteor.energy_megatons.toFixed(2)} Megatons TNT<br>
        <strong>Miss Distance:</strong> ${meteor.miss_distance_km.toFixed(0)} km
      `;
      
      updateLaunchButton();
      updateLocationStatus();
    }

    // Map functionality
    const MAPTILER_KEY = '0GCZRo8V9UPQFhWV1vt6';
    let map;
    let marker = null;

    window.addEventListener('load', function() {
      // Load NASA data
      loadNEOData();

      // Initialize map
      map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`,
        center: [0, 20],
        zoom: 2
      });

      map.setMaxBounds([[-179.999, -85], [179.999, 85]]);
      map.addControl(new maplibregl.NavigationControl(), 'top-right');

      map.on('click', function(e) {
        const { lng, lat } = e.lngLat;
        addMarker(lng, lat);
        selectedLocationName = 'Custom Location';
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
      });
    });

    function addMarker(lng, lat) {
      if (marker) marker.remove();

      const el = document.createElement('div');
      el.className = 'marker';
      marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);

      selectedLat = lat;
      selectedLng = lng;
      createEarthMarker(lat, lng);
      updateLaunchButton();
      updateLocationStatus();
    }

    function updateLaunchButton() {
      const btn = document.getElementById('launch-btn');
      if (selectedMeteor && selectedLat !== null && selectedLng !== null) {
        btn.classList.remove('disabled');
      } else {
        btn.classList.add('disabled');
      }
    }

    function updateLocationStatus() {
      const status = document.getElementById('location-status');
      if (selectedMeteor && selectedLat !== null) {
        status.innerHTML = `‚úÖ Ready: ${selectedMeteor.name} ‚Üí ${selectedLocationName} (${selectedLat.toFixed(4)}¬∞, ${selectedLng.toFixed(4)}¬∞)`;
      } else if (selectedMeteor) {
        status.innerHTML = `‚ö†Ô∏è Asteroid selected: ${selectedMeteor.name}. Please choose target location.`;
      } else if (selectedLat !== null) {
        status.innerHTML = `‚ö†Ô∏è Location selected: ${selectedLocationName}. Please choose an asteroid.`;
      } else {
        status.innerHTML = 'Select an asteroid and target location to begin';
      }
    }

    function goToCoordinates() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (isNaN(lat) || isNaN(lng)) {
        alert('Please enter valid coordinates!');
        return;
      }
      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        alert('Invalid coordinates! Latitude: -90 to 90, Longitude: -180 to 180');
        return;
      }
      addMarker(lng, lat);
      selectedLocationName = `Custom (${lat.toFixed(2)}¬∞, ${lng.toFixed(2)}¬∞)`;
      if (map) map.flyTo({ center: [lng, lat], zoom: 10, duration: 2000 });
    }

    async function searchLocation() {
      const query = document.getElementById('location-search').value.trim();
      if (!query) {
        alert('Please enter a location name!');
        return;
      }
      
      try {
        const response = await fetch(
          `https://api.maptiler.com/geocoding/${encodeURIComponent(query)}.json?key=${MAPTILER_KEY}`
        );
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          const [lng, lat] = data.features[0].center;
          const place = data.features[0];
          selectedLocationName = place.place_name || query;
          
          addMarker(lng, lat);
          
          if (map) {
            const zoomLevel = place.place_type[0] === 'country' ? 5 : 
                             place.place_type[0] === 'region' ? 7 : 
                             place.place_type[0] === 'place' ? 10 : 12;
            
            map.flyTo({
              center: [lng, lat],
              zoom: zoomLevel,
              duration: 2000
            });
          }
          
          document.getElementById('lat').value = lat.toFixed(6);
          document.getElementById('lng').value = lng.toFixed(6);
          console.log(`Found location: ${selectedLocationName} at (${lat}, ${lng})`);
        } else {
          alert('Location not found! Try another search term.');
        }
      } catch (error) {
        console.error('Search error:', error);
        alert('Search failed! Please check your internet connection.');
      }
    }

    document.getElementById('lat').addEventListener('keypress', e => {
      if (e.key === 'Enter') goToCoordinates();
    });
    document.getElementById('lng').addEventListener('keypress', e => {
      if (e.key === 'Enter') goToCoordinates();
    });
    document.getElementById('location-search').addEventListener('keypress', e => {
      if (e.key === 'Enter') searchLocation();
    });

    function launchSimulation() {
      if (!selectedMeteor || selectedLat === null || selectedLng === null) {
        alert('Please select both an asteroid and a target location!');
        return;
      }
      
      // Calculate mass using density of stone asteroid (~2600 kg/m¬≥)
      const volume = (4/3) * Math.PI * Math.pow(selectedMeteor.diameter_m / 2, 3);
      const mass = volume * 2600;
      
      // Store all data for the simulation page
      sessionStorage.setItem('targetLat', selectedLat);
      sessionStorage.setItem('targetLng', selectedLng);
      sessionStorage.setItem('targetName', selectedLocationName);
      sessionStorage.setItem('meteorName', selectedMeteor.name);
      sessionStorage.setItem('meteorSpeed', selectedMeteor.velocity_km_s);
      sessionStorage.setItem('meteorMass', mass.toFixed(0));
      sessionStorage.setItem('meteorDiameter', selectedMeteor.diameter_m);
      sessionStorage.setItem('meteorEnergy', selectedMeteor.energy_megatons);
      sessionStorage.setItem('meteorId', selectedMeteor.id);
      sessionStorage.setItem('meteorMissDistance', selectedMeteor.miss_distance_km);
      
      console.log('Launching simulation with data:', {
        asteroid: selectedMeteor.name,
        location: selectedLocationName,
        coordinates: [selectedLat, selectedLng],
        mass: mass,
        energy: selectedMeteor.energy_megatons
      });
      
      window.location.href = 'test10.html';
    }
  </script>
</body>
</html>